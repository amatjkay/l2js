# FocusGuard: распознавание активного окна и безопасные действия

Этот документ описывает систему FocusGuard, проверку активности окна игры и правила выполнения действий (наведение, клик) с учётом требований безопасности.

---

## Назначение
FocusGuard предотвращает любые действия (мышь/клавиатура), если активное окно не сопоставляется с окном игры. Это исключает случайные клики по рабочему столу/другим программам.

---

## Критерии сопоставления окна
Конфигурация в `settings.json → actions.focusCheck` и `actions.windowMatch`.
- focusCheck.criteria — быстрые критерии для сравнения с активным окном:
  - titleContains: подстрока в заголовке (например, "LU4").
  - classEquals: точное совпадение класса окна (например, UnrealWindow).
  - processNameContains: подстрока имени процесса.
  - hwndEquals: точный дескриптор окна (hex → number).
- focusCheck.autoActivate: разрешить автоактивацию целевого окна при несовпадении.
- focusCheck.activateTitle: точный заголовок для попытки `AppActivate`. Для игры стабильно используется точное значение "LU4  " (с двумя пробелами).

Backend PowerShell-скрипт: `tools/find-window.ps1`. Используется из `src/core/FocusGuard.ts` через вспомогательные функции `psActive/psFind/psActivate`.

---

## Поведение
1) При выполнении любого действия через `FocusGuard.guard()` сначала вызывается `ensureGameActive()`.
2) Активное окно сравнивается по критериям. Если совпадает — действие разрешено.
3) Если нет — при `autoActivate=true` выполняется поиск и попытка активации, затем повторная проверка.
4) При неудаче действие пропускается с предупреждением в логах.

Логи содержат:
- найденные признаки совпадения (title/class/process/hwnd),
- сведения об активном окне при отказе,
- результат попыток автоактивации (AppActivate/SetForegroundWindow).

---

## Таргетинг и смещение клика
Для повышения точности клика по обнаруженной надписи цели реализовано конфигурируемое вертикальное смещение курсора перед кликом:
- Параметр: `actions.clickOffsetY` (по умолчанию 35, положительное значение смещает курсор вниз).
- Применение:
  - Режим Arduino: смещение учитывается при расчёте относительного `BIGMOVE(dx, dy)`.
  - Режим PowerShell/robotjs: курсор перемещается на абсолютные координаты `y + clickOffsetY`.
- Место в коде: `src/spoiler/states/TargetState.ts`.

Параметры безопасных задержек: `actions.delays.{beforeMoveMs,afterMoveMs,beforeClickMs,afterClickMs}` — используются вокруг наведения и клика.

---

## Камера и fallback
Если целей нет, в `ScanState` используются лёгкие случайные повороты камеры (Arduino):
- `actions.camera.{dxMin,dxMax,pauseMs}` — диапазон амплитуды и пауза стабилизации перед повторным сканом.
- В логах указывается команда `==> CAMERA dx dy`.

---

## Связь с FSM
- `ScanState`: запускает CV-пайплайн, складывает цели (`Target[]`) в контекст FSM.
- `TargetState`: выбирает цель, наводится (с учётом `clickOffsetY`), выполняет клик, затем возвращается в `IdleState`.
- `IdleState`: ожидание перед повторным сканированием.

---

## Рекомендации
- Если возникают промахи по цели: увеличивайте `actions.clickOffsetY` на 5–10px и тестируйте на 2–3 сценах.
- При частых ложных окнах проверьте точное значение заголовка `focusCheck.activateTitle = "LU4  "` и критерии `criteria`.
- Для нестабильного Serial увеличьте `actions.serial.readTimeoutMs` и `actions.serial.retries`.
